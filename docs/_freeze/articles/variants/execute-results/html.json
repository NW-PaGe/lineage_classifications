{
  "hash": "c803c9dc4c2b9481b574f4249fc64dfc",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Statewide COVID-19 Variant Plot\"\ndescription: Display COVID-19 variants by specimen collection date\ndate: September 1, 2023\ndate-modified: today\nauthor: \n  - name: Frank Aragona\n    email: frank.aragona@doh.wa.gov\n    affiliations:\n      - Washington Department of Health\n      - Data Integration/Quality Assurance\nformat: \n  html:\n    fig-width: 10\n    fig-height: 7\n    scss: styles.scss\n    code-fold: show\n    code-overflow: wrap\n    class-output: \"watch\"\n    toc: true\n    number-sections: true\nexecute: \n  freeze: true\n---\n\n::: {.cell warnings='false'}\n\n:::\n\n\n\n\n<!--\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfile.path(dirname(rprojroot::find_rstudio_root_file()),\"scripts/plots.R\") |> print()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"C:/Users/FAA3303/Projects/NW-PAGE/private-lineages/scripts/plots.R\"\n```\n\n\n:::\n:::\n\n\n\n-->\n\n\n\n\n\n::: {.cell warnings='false'}\n\n:::\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n::: {.cell-output-display}\n![](variants_files/figure-html/var-plot-1.png){width=960}\n:::\n:::\n\n\n\n\n# How to make the plot\n\nHere's the code to make the plot. If you want the actual script it will be in the repository under the scripts folder called `plots.R`\n\n## Libraries\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(pacman)\np_load(\n  reticulate,\n  fs,\n  lubridate,\n  dplyr,\n  stringr,\n  magrittr,\n  readr,\n  httr,\n  readxl,\n  ggplot2,\n  ggtext,\n  ggthemes,\n  forcats,\n  here\n)\n# set path\nroot_path <- here() %>% str_remove(\"/docs\")\n```\n:::\n\n\n\n\n## Pull the data\n\nFirst we can pull the example dataset which is in the repo. This dataset comes directly from the WA DOH COVID-19 dashboard.\n\n-   pull the data\n-   prepare it so we can plot it\n-   use `dplyr::group_by()` to get date range groups for the bars in the plot\n-   we can also adjust some of the labels here so they have `%` attached to them\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n(\n  variants <- read_xlsx(file.path(root_path,\"data/Downloadable_variant.xlsx\")) %>%\n    rename(c(\"start_date\" = `Start Date`,\n             \"end_date\" = `End Date`,\n             \"variant\" = `Variant`,\n             \"seven_day_count\" = `7-Day Sequence Count`,\n             \"seven_day_percent\" = `7-Day Percent`,\n             \"datetime\" = `Date/Time Updated`)) %>%\n    # make the date ranges for the plot\n    # group each date range\n    group_by(start_date,end_date) %>%\n    # assign each date range an id wtih dplyr::cur_group_id()\n    mutate(group_id = cur_group_id()) %>%\n    # create labels for the groups\n    mutate(group_label = paste(start_date, \" - \\n\", end_date)) %>%\n    # add % to the percent labels\n    mutate(percent_label = paste0(seven_day_percent,\"%\")) %>%\n    ungroup()\n)\n```\n:::\n\n\n\n\n## Make the plot\n\nNow we can make the plot. I used:\n\n-   `fill=variant` to get the colors stratified by variant\n-   `geom_bar()` to make the bars and `position=\"stack\"` to stack different groups of variants per bar\n-   the `labs()` function to adjust how the title looks and add my own html to it. Then I adjusted that title background under the `theme(plot.title())` functions\n-   for the legend I used `theme(legend.background())` to adjust the colors and background formatting\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n(\n  variants %>%\n    ggplot(aes(y=seven_day_percent,\n               x=group_label,\n               fill=variant,\n               label=percent_label)) +\n    geom_bar(position=\"stack\", stat=\"identity\") +\n    geom_text(\n      aes(\n        label=ifelse(\n          seven_day_percent>4.0,\n          percent_label,\n          \"\"\n          )\n        ),\n      size = 3,\n      position = position_stack(vjust = 0.5),\n      color=\"white\") +\n    scale_fill_viridis_d(na.value = \"red\") +\n    # Add percent sign \n    scale_y_continuous(labels = function(x) paste0(x, \"%\")) +\n    labs(\n         # Without the caption, the dates get cut off in the email..\n         caption = \"\",\n         x = \"Specimen Collection Date\",\n         y = \"\",\n         title = \"<b><span style = 'font-size:14pt;'>Statewide COVID-19 Variants: Last 12 Weeks</span></b><br>This chart shows the percent of genetic mutations (or variants) of the COVID-19 virus by lineage for the past 6 weeks. Knowing how the virus is changing and which variants are found helps inform our public health response, which includes developing and recommending effective vaccines and treatments\") +\n    theme_bw() +\n    theme(\n      # take out the default background\n      strip.background  = element_blank(),\n      # Adjust where the legend is an put a sick background behind it\n      legend.position = 'right',\n      legend.background = element_rect(fill = \"lightblue\",\n                                       linetype = \"solid\",\n                                       color = \"darkblue\",\n                                       linewidth = 1),\n      legend.direction = \"vertical\", legend.box = \"horizontal\",\n      plot.title.position = \"plot\",\n      plot.title = element_textbox_simple(\n        maxwidth = unit(6,\"in\"),\n        hjust = .0005,\n        size = 10,\n        padding = margin(5.5, 5.5, 5.5, 5.5),\n        margin = margin(0, 0, 5.5, 0),\n        fill = \"cornsilk\"\n      )) +\n    # Again adjust where the legend should be and how it should be labeled\n    guides(fill = guide_legend(title = \"Variants\", \n                               title.position = \"top\",\n                               title.hjust = .5,\n                               byrow = TRUE,\n                               override.aes = list(size=5.5)),\n           size = guide_legend( )) \n)\n```\n:::\n",
    "supporting": [
      "variants_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}